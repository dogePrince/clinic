{% extends 'ui/base.html' %}
{% load static %}

{% block content %}
<div id="app_patient">
  <navbar-template></navbar-template>
  <breadcrumb-template :nav_items="nav_items"></breadcrumb-template>
  <div class="container">
    <div class="alert-container">
      <transition-group name="list" tag="div">
        <alert-template v-for="alert in alert_list" :key="alert.content" :status="alert.status">[% alert.content %]</alert-template>
      </transition-group>
    </div>
    <div class="row justify-content-center">
      <div v-if="for_new" class="col-8">
        <h3>新建病例</h3>
        <case-form-template :case_obj="case_obj" :patient_option="patient_option" :template_option="template_option"></case-form-template>
        <button type="button" class="btn btn-primary" v-on:click="submit">新建病例</button>
      </div>
      <div v-else class="col-8">
        <h3>病例详情
          <span class="float-right"><a class="btn btn-outline-primary btn-sm" :href="new_case_from_this">从此病例新建 <span class="oi oi-file"></span></a></span>
        </h3>
        <case-form-template :case_obj="case_obj" :patient_option="patient_option" :template_option="template_option"></case-form-template>
        <button type="button" class="btn btn-primary" v-on:click="submit">更改病例</button>
        <button type="button" class="btn btn-danger" v-on:click="submit">删除病例</button>
      </div>
    </div>
    <br v-for="i in 2"/>
    <modal-template :info="modal_info" :confirm="confirm">
      <case-info-template v-if="for_new" :case_info="[case_obj]" :patient_option="patient_option" :template_option="template_option"></case-info-template>
      <case-info-template v-else :case_info="[case_obj_old, case_obj]" :patient_option="patient_option" :template_option="template_option" class="justify-content-center"></case-info-template>
    </modal-template>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'ui/components/NavbarTemplate.js' %}"></script>
<script src="{% static 'ui/components/BreadcrumbTemplate.js' %}"></script>
<script src="{% static 'ui/components/AlertTemplate.js' %}"></script>
<script src="{% static 'ui/components/ModalTemplate.js' %}"></script>
<script src="{% static 'ui/components/CaseInfoTemplate.js' %}"></script>
<script src="{% static 'ui/components/AutoTextTemplate.js' %}"></script>
<script src="{% static 'ui/components/CaseFormTemplate.js' %}"></script>

<script>
  new Vue({
    delimiters: ['[%', '%]'],
    el: '#app_patient',
    created: function() {
      var current_url = window.location.pathname;
      var last_string = current_url.substring(current_url.lastIndexOf('/') + 1);

      if (last_string == 'new') {
        this.page_type = 'new';
        this.init_page_for_new_case();
      }
      else {
        this.case_id = parseInt(last_string, 10);
        this.init_page_for_case(this.case_id);
      }

      this.load_patient_option();
      this.load_template_option();
    },
    data: {
      case_obj: {patient:null, template: null, prescription: ''},
      case_obj_old: {},
      alert_list: [],
      patient_option: [],
      template_option: []
    },
    computed: {
      modal_info: function() {
        return {
          id: 'diffModal',
          title: this.for_new ? '确认新建吗？' : '确认更改吗？',
          size: this.for_new ? null : 'xl'
        }
      },
      modal_id: function() {
        return "#" + this.modal_info.id;
      },
      for_new: function() {
        return this.page_type == 'new';
      },
      new_case_from_this: function() {
        return this.route_obj_by_alias('case_new', { case: this.case_id }).url;
      },
      nav_items: function() {
        if (this.for_new) {
          if (this.case_obj.patient) {
            return this.nav_items = [['home'], ['search'], ['patient_detail', {'id': this.case_obj.patient}], ['case_new']];
          }
          return [['home'], ['search'], ['case_new']];
        }
        if (this.case_obj.patient) {
          return this.nav_items = [['home'], ['search'], ['patient_detail', {'id': this.case_obj.patient}], ['case_detail', {'id': this.case_id}]];
        }
        return this.nav_items = [['home'], ['search'], ['case_detail', {'id': this.case_id}]];
      }
    },
    methods: {
      init_page_for_case: function(case_id) {
        if (new URLSearchParams(window.location.search).get('save')) {
          this.alert_list.push({content: "新建成功！", status: "success"});
          setTimeout(function(){ this_vm.alert_list.shift(); }, 3000);
        }

        var this_vm = this;
        this.load_case(case_id).then(function () {
          this_vm.case_obj_old = _.clone(this_vm.case_obj);
        });
      },
      init_page_for_new_case: function() {
        var url_param = new URLSearchParams(window.location.search);
        var patient_id = url_param.get('patient');
        var case_id = url_param.get('case');
        patient_id = patient_id && parseInt(patient_id, 10);
        case_id = case_id && parseInt(case_id, 10);

        var this_vm = this;

        if (patient_id) {
          setTimeout(function() {
            this_vm.case_obj = {patient: patient_id, template: null, prescription: ''};
          }, 1);
        }else if(case_id) {
          this.load_case(case_id).then(function() {
            this_vm.case_obj.id = null;
          });
        }
      },
      chinese_compare: function(var1, var2) {
        return var1.name.localeCompare(var2.name, "zh-CN");
      },
      load_patient_option: function() {
        var this_vm = this;
        this.get_patient_option().then(function ({data}) {
          this_vm.patient_option = data.list.sort(this_vm.chinese_compare);;
        }).catch(function (error) {
          console.log(error);
        });
      },
      load_template_option: function() {
        var this_vm = this;
        this.get_template_option().then(function ({data}) {
          var sorted_list = data.list.sort(this_vm.chinese_compare);
          sorted_list.unshift({id: null, name: '无'});
          this_vm.template_option = sorted_list;
        }).catch(function (error) {
          console.log(error);
        });
      },
      load_case: function(case_id) {
        var this_vm = this;
        return this.get_case_by_id(case_id)
          .then(function ({data}) {
            this_vm.case_obj = data;
          });
      },
      submit: function() {
        $(this.modal_id).modal('show');
      },
      confirm: function() {
        var this_vm = this;
        this.post_case(this.case_obj)
          .then(function ({data}) {
            if (data.success) {
              if (this_vm.for_new) {
                window.location.href = this_vm.route_obj_by_alias('case_detail', {id: data.data.id, save: true}).url;
              }
              else {
                $(this_vm.modal_id).modal('hide');
                this_vm.alert_list.push({content: "修改成功！", status: "success"});
                setTimeout(function(){ this_vm.alert_list.shift() }, 3000);
              }
            }
          }).catch(function (error) {
            console.log(error);
          });
      },
    }
  });
</script>
{% endblock %}
