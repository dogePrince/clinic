{% extends 'ui/base.html' %}
{% load static %}

{% block content %}
<div id="app_patient">
  <navbar-template></navbar-template>
  <breadcrumb-template :nav_items="nav_items"></breadcrumb-template>
  <div class="container" style="position: relative;">
    <div class="alert-container">
      <transition-group name="list" tag="div">
        <alert-template v-for="alert in alert_list" :key="alert.content" :status="alert.status">[% alert.content %]</alert-template>
      </transition-group>
    </div>
    <div class="row justify-content-center">
      <div v-if="for_new" class="col-8">
        <h3>新建访客</h3>
        <patient-form-template :patient_obj="patient_obj"></patient-form-template>
        <button type="button" class="btn btn-primary" v-on:click="submit">新建访客</button>
      </div>
      <div v-else class="col-8">
        <h3>访客详情</h3>
        <patient-form-template :patient_obj="patient_obj"></patient-form-template>
        <button type="button" class="btn btn-primary" v-on:click="submit">更改访客</button>
        <button type="button" class="btn btn-danger" v-on:click="delete_obj">删除访客</button>
        <br v-for="i in 3"/>
        <h3>历史记录</h3>
        <case-table-template :case_list="case_list" :btn_param="btn_new_param"></case-table-template>
        <pagination-template :info="page_info" :jump="jump" class="justify-content-center"></pagination-template>
      </div>
    </div>
  </div>
  <br v-for="i in 2"/>
  <modal-template :info="diff_modal_info" :confirm="submit_confirm">
    <patient-info-template v-if="for_new" :patient_info="[patient_obj]"></patient-info-template>
    <patient-info-template v-else :patient_info="[patient_obj_old, patient_obj]" class="justify-content-center"></patient-info-template>
  </modal-template>
  <modal-template v-if="!for_new" :info="delete_modal_info" :confirm="delete_confirm">
    <patient-info-template :patient_info="[patient_obj]"></patient-info-template>
  </modal-template>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'ui/components/NavbarTemplate.js' %}"></script>
<script src="{% static 'ui/components/BreadcrumbTemplate.js' %}"></script>
<script src="{% static 'ui/components/AlertTemplate.js' %}"></script>
<script src="{% static 'ui/components/ModalTemplate.js' %}"></script>
<script src="{% static 'ui/components/PatientInfoTemplate.js' %}"></script>
<script src="{% static 'ui/components/PatientFormTemplate.js' %}"></script>
<script src="{% static 'ui/components/TableCaptionTemplate.js' %}"></script>
<script src="{% static 'ui/components/CaseTableTemplate.js' %}"></script>
<script src="{% static 'ui/components/PaginationTemplate.js' %}"></script>

<script>
  vv = new Vue({
    delimiters: ['[%', '%]'],
    el: '#app_patient',
    created: function() {
      var current_url = window.location.pathname;
      var last_string = current_url.substring(current_url.lastIndexOf('/') + 1);

      if (last_string == 'new') {
        this.page_type = 'new';
        this.init_page_for_new_patient();
      }
      else {
        this.patient_id = parseInt(last_string, 10);
        this.init_page_for_patient(this.patient_id);
      }
    },
    data: {
      patient_obj: {sex: 'F'},
      patient_obj_old: {},
      case_list: [],
      page_info: {},
      alert_list: []
    },
    computed: {
      diff_modal_info: function() {
        return {
          id: 'diffModal',
          title: this.for_new ? '确认新建吗？' : '确认更改吗？',
          size: this.for_new ? null : 'xl',
          submit_btn: {
            name: this.for_new ? '新建访客' : '保存更改',
            type: 'primary'
          }
        }
      },
      delete_modal_info: function() {
        return {
          id: 'deleteModal',
          title: '确认删除吗？',
          size: 'lg',
          submit_btn: {
            name: '删除访客',
            type: 'danger'
          }
        }
      },
      diff_modal_id: function() {
        return "#" + this.diff_modal_info.id;
      },
      delete_modal_id: function() {
        return "#" + this.delete_modal_info.id;
      },
      for_new: function() {
        return this.page_type == 'new';
      },
      btn_new_param: function() {
        return {patient: this.patient_id};
      }
    },
    methods: {
      init_page_for_patient: function(patient_id) {
        this.nav_items = [['home'], ['search'], ['patient_detail', {'id': patient_id}]];

        var search_param = new URLSearchParams(window.location.search);
        if (search_param.get('save')) {
          this.alert_list.push({content: "新建成功！", status: "success"});
          setTimeout(function(){ this_vm.alert_list.shift(); }, 3000);
        }
        if (search_param.get('delete')) {
          this.alert_list.push({content: "删除成功！", status: "danger"});
          setTimeout(function(){ this_vm.alert_list.shift(); }, 3000);
        }

        var this_vm = this;
        this.load_patient(patient_id)
          .then(function () {
            this_vm.patient_obj_old = _.clone(this_vm.patient_obj);
          });
        this.load_case_page(1);
      },
      init_page_for_new_patient: function() {
        this.nav_items = [['home'], ['search'], ['patient_new']];
      },
      load_patient: function(patient_id) {
        var this_vm = this;
        return this.get_patient_by_id(patient_id, {recent_field: true})
          .then(function ({data}) {
            this_vm.patient_obj = data;
          });
      },
      load_case_page: function(page) {
        var this_vm = this;
        this.get_case({page: page, patient_field: true, patient_id: this.patient_id})
          .then(function ({data}) {
            this_vm.case_list = data.list;
            this_vm.page_info = {
              current: data.page_num,
              total: data.total_page
            }
          });
      },
      submit: function() {
        $(this.diff_modal_id).modal('show');
      },
      submit_confirm: function() {
        var this_vm = this;
        this.post_patient(this.patient_obj)
          .then(function ({data}) {
            if (data.success) {
              if (this_vm.for_new) {
                window.location.href = this_vm.route_obj_by_alias('patient_detail', {id: data.data.id, save: true}).url;
              }
              else {
                $(this_vm.diff_modal_id).modal('hide');
                this_vm.alert_list.push({content: "修改成功！", status: "success"});
                setTimeout(function(){ this_vm.alert_list.shift() }, 3000);
              }
            }
          }).catch(function (error) {
            console.log(error);
          });
      },
      delete_obj: function() {
        $(this.delete_modal_id).modal('show');
      },
      delete_confirm: function() {
        var this_vm = this;
        this.delete_patient_by_id(this.patient_obj.id)
          .then(function ({data}) {
            if (data.success) {
              window.location.href = this_vm.route_obj_by_alias('search', {delete: true, focus: 'patient'}).url;
            }
          }).catch(function (error) {
            console.log(error);
          });
      },
      jump: function(num) {
        this.load_case_page(num);
      }
    }
  })
</script>
{% endblock %}
