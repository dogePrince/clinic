{% extends 'ui/base.html' %}
{% load static %}

{% block content %}
<div id="app_patient_new">
  <navbar-template></navbar-template>
  <breadcrumb-template :nav_items="nav_items"></breadcrumb-template>
  <div class="container" style="position: relative;">
    <div class="alert-container">
      <transition-group name="list" tag="div">
        <alert-template v-for="alert in alert_list" :key="alert.content" :status="alert.status">[% alert.content %]</alert-template>
      </transition-group>
    </div>
    <div class="row justify-content-center">
      <div class="col-8">
        <h3>新建访客</h3>
        <patient-form-template :patient_obj="patient_obj"></patient-form-template>
        <button type="button" class="btn btn-primary" v-on:click="submit">新建访客</button>
      </div>
    </div>
  </div>
  <br v-for="i in 2"/>
  <modal-template :info="modal_info" :confirm="confirm">
    <div class="row">
      <patient-info-template :patient_info="patient_obj"></patient-info-template>
    </div>
  </modal-template>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'ui/components/NavbarTemplate.js' %}"></script>
<script src="{% static 'ui/components/BreadcrumbTemplate.js' %}"></script>
<script src="{% static 'ui/components/AlertTemplate.js' %}"></script>
<script src="{% static 'ui/components/ModalTemplate.js' %}"></script>
<script src="{% static 'ui/components/PatientInfoTemplate.js' %}"></script>
<script src="{% static 'ui/components/PatientFormTemplate.js' %}"></script>
<script src="{% static 'ui/components/TableCaptionTemplate.js' %}"></script>
<script src="{% static 'ui/components/CaseTableTemplate.js' %}"></script>
<script src="{% static 'ui/components/PaginationTemplate.js' %}"></script>

<script>
  new Vue({
    delimiters: ['[%', '%]'],
    el: '#app_patient_new',
    data: {
      patient_obj: {},
      alert_list: [],
      nav_items: [['home'], ['search'], ['patient_new']],
      modal_info: {
        id: 'diffModal',
        title: '访客信息确认：'
      }
    },
    computed: {
      modal_id : function() {
        return "#" + this.modal_info.id;
      }
    },
    methods: {
      submit: function() {
        $(this.modal_id).modal('show');
      },
      confirm: function() {
        var this_vm = this;
        this.post_patient(this.patient_obj)
          .then(function (response) {
            if (response.data.success) {
              $(this_vm.modal_id).modal('hide');
              window.location.href = this_vm.route_obj_by_alias('patient_detail', {id: response.data.data.id, save: true}).url;
            }
          }).catch(function (error) {
            console.log(error);
          });
      }
    }
  })
</script>
{% endblock %}
